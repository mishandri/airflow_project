config = [
    {
        "table_name": "mikhail_k_agg_daily_orders",
        "table_ddl": """
            CREATE TABLE IF NOT EXISTS {{ table_name }} (
                ds              DATE NOT NULL,
                region          TEXT,
                total_orders    BIGINT,
                total_amount    NUMERIC(18,2),
                PRIMARY KEY (ds, region)
            )
            PARTITION BY RANGE (ds);
        """,
        "table_dml": """
            INSERT INTO {{ table_name }}
            SELECT
                DATE(transaction_date) AS ds,
                region,
                COUNT(*) AS total_orders,
                SUM(amount) AS total_amount
            FROM raw.orders
            WHERE transaction_date >= '{{ ds }}'::DATE
              AND transaction_date < '{{ next_ds }}'::DATE
            GROUP BY 1, 2
            ON CONFLICT (ds, region) DO UPDATE
            SET total_orders = EXCLUDED.total_orders,
                total_amount = EXCLUDED.total_amount;
        """,
        "need_to_export": True,
        "export_path": "s3://mikhail-k/exports/{{ table_name | replace('.', '/') }}/{{ ds }}.csv"
    },
    {
        "table_name": "mikhail_k_agg_user_cohorts",
        "table_ddl": """
            CREATE TABLE IF NOT EXISTS {{ table_name }} (
                cohort_month    DATE NOT NULL,
                month_offset    INT NOT NULL,
                retained_users  BIGINT,
                PRIMARY KEY (cohort_month, month_offset)
            );
        """,
        "table_dml": """
            INSERT INTO {{ table_name }} (cohort_month, month_offset, retained_users)
            SELECT
                DATE_TRUNC('month', first_order_date)::DATE AS cohort_month,
                EXTRACT(month FROM AGE('{{ ds }}'::DATE, first_order_date))::INT AS month_offset,
                COUNT(DISTINCT user_id) AS retained_users
            FROM mikhail_k_user_first_order u
            WHERE EXISTS (
                SELECT 1 FROM raw.orders o
                WHERE o.user_id = u.user_id
                  AND o.order_date >= '{{ ds }}'::DATE
                  AND o.order_date < '{{ next_ds }}'::DATE
            )
            GROUP BY 1, 2
            ON CONFLICT (cohort_month, month_offset) DO UPDATE
            SET retained_users = EXCLUDED.retained_users;
        """,
        "need_to_export": False
    }
]